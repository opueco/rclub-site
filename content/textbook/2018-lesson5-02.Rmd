---
title: "Lesson 5-2: 正規表現"
date: "2018-12-03 00:00:01 +0900"
categories:
  - textbook
tag:
  - R
slug: 2018-5-2
output: 
  blogdown::html_page:
    toc: true
monofont: Ricty Discord
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(prompt = FALSE)
View <- knitr::kable
pwt90 <- haven::read_dta("~/Data/pwt90.dta")

source("../../R/knitr-setup.R")
source("../../R/util.R")

cnt_exe <- counter()
cnt_exa <- counter()
cnt_prb <- counter()
cnt_scr <- counter()
```

# 前のステップ {#pre}

[Lesson 5-1: R の文字列](`r blogdown::shortcode("ref", "2018-lesson5-01.html")`) では次のことを勉強しました。

- 文字列について
- **stringr**
- **gutenbergr** の紹介

# このセッションの目標 {#goal}

R で文字列を扱う方法を学びます。特に，

- 正規表現

の基本を学びます。

# 準備 {#prep}

ここでも **stringr** を使います。

```{r}
library(tidyverse)
```

Cheat Sheet は前回と同様，こちら <https://www.rstudio.com/resources/cheatsheets/#stringr>  です。


## 正規表現 {#regex}

テキスト処理では，与えられた文字列の中に特定の文字列や文字列の類型（パターン）が含まれるかどうかを調べて，マッチする部分を数えたり，別の文字で置き換えたりするということがよくあります。

例えば，次のようなテキストファイルがあったとしましょう。

```
Alice <alice@example.com>
Bob <bob@example.org>
Charlie <charl@example.net>
```

このテキストファイルを次のような表形式データに変換したいとします（要するに tibble にしたいのです）。3行くらいなら手作業の方が早いかもしれませんが，数千行になったらどうしましょう。（学生アルバイトを雇うよりも早く確実に処理する方法があります）

| name    | user  | domain      |
|---------|-------|-------------|
| Alice   | alice | example.com |
| Bob     | bob   | example.org |
| Charlie | charl | example.net |


このような目的で使える強力なツールがあります。正規表現（regular expressions, regex）と呼ばれる，「文字のパターン」に対して処理を行うための規則です。上の例では，行ごとに内容は違うものの，次のような明確なパターンがありました。

```
name <user@domain>
```

このように一定のパターンに従う文字の並びを探し出して，処理を実行するのが正規表現の役割です。

## 実験 {#experiment}

正規表現は R とは独立して定義されているものなので，正規表現の習得に R言語は必要ではありません。

RStudio で新しい「Text File」を作成し，

```
Alice <alice@example.com>
Bob <bob@example.org>
Charlie <charl@example.net>
```

をコピーしてください。

![テキストエディタ](/images/2018-5-1-1.png)

次に，Ctrl+F （Mac なら Comman+F） を押すと検索窓が現れますので，

- "Regex" にチェックを入れる
- 左の入力フォーム（検索欄）には「`(.*) <(.*)@(.*)>`」を入力
- 右の入力フォーム（置換欄）には「`\1,\2,\3`」を入力

して，「All」をクリックしてください。コンマ区切りのデータに置き換わったはずです。これが正規表現の効能です。

## 正規表現の初歩 {#regex-intro}

次のことを覚えるだけでテキスト処理がかなり上達します。

#### 文字を表す正規表現 {#regex-char}

| 探しもの       | regex   | R       |
|----------------|---------|---------|
| 特定の文字列   | `abc`   | `abc`   |
| 任意の文字     | `.`     | `.`     |
| 数字（その1）  | `[0-1]` | `[0-1]` |
| 数字（その2）  | `\d`    | `\\d`   |
| 記号を除く文字 | `\w`    | `\\w`   |
| 記号           | `\W`    | `\\W`   |
| ピリオド       | `\.`   | `\\.`    |


**例 5.2.`r cnt_exa()`  

`\d+-\d+-\d+` という正規表現は 090-xxxx-yyyy の形式の電話番号を探す単純な正規表現です。電話番号が記録されているデータがあったときに携帯電話の割合などを調べるのに使えそうですね。

#### グループ {#regex-group}

| グループ         | regex           |
|------------------|-----------------|
| どれか1つ        | `[abc]` など    |
| どれでもない     | `[^abc]` など   |
| この並びで現れる | `(abc)` など    |
| いずれか         | `(ab|cd)` など  |

#### 量を表す正規表現 {#regex-quant}

| 量               | regex   |
|------------------|---------|
| 0個以上          | `*`     |
| 1個以上          | `+`     |
| 0 or 1           | `?`     |
| n個              | `{n}`   |
| n個以上          | `{n,}`  |
| n個以下          | `{,n}`  |
| m個以上，n個以下 | `{m,n}` |

#### 位置を表す正規表現 {#regex-anchor}

| 位置     | regex | R     |
|----------|-------|-------|
| 行頭     | `^`   | `^`   |
| 行末     | `$`   | `$`   |
| 単語境界 | `\b`  | `\\b` |

#### 後方参照 {#regex-ref}

丸括弧（`( )`）はグループ化するために使えることを上の表で紹介しました。例えば `(ab)+` は `ababab` などにマッチする。丸括弧は，他にも「後で使えるようにしたりするため」にも使われます。最初に現れた `( )` に
該当する部分を `\1` で呼び出すことができます。


さきほどの例 `(.*) <(.*)@(.*)>` を `\1,\2,\3` に置換するというのは，

- `(.*)` は「任意の文字列」をグループ化して後で使う
- ` <`, `@`, `>` はその位置に正にその文字があるということなので，
- 「文字列1 <文字列2@文字列3>」 を探し
- これを「文字列1,文字列2,文字列3」に置き換える

ということをやっていました。

実際にはドメインに使える文字・記号が決まっているのでそのようなルールを課す方が安全（例えば，スペースやコンマは入らないとか）なのですが，正規表現を極める方向に進むのは得策ではないかもしれません。（とても難しいので）

とりあえずのところは「正規表現という強力なツールが存在している」ということさえ認識していただければ OK です。正規表現が必要になるタスクに出会うたびに正規表現のルールを確認していきましょう。

## R の正規表現 {#regex-in-r}

R で正規表現を使うときに 1つだけ注意をしてほしい点があります。それは「正規表現で使われるバックスラッシュ `\` は R では `\\` になる」ということです。例えば，`\w` は通常の文字（a, b, c など）にマッチする正規表現ですが，R は `\w` を R のエスケープ文字だと推定してしまうので（そのようなエスケープ文字は存在しないので）エラーになります。`\` のエスケープ文字`\\`を使ってこの問題を回避する必要があるのです。

それでは例題のデータを tibble に変換してみましょう。

```{r}
dta <- "Alice <alice@example.com>
Bob <bob@example.org>
Charlie <charl@example.net>"
writeLines(dta)
```

```{r}
address <- 
  dta %>% 
  str_split("\n") %>% 
  unlist()
address
```

```{r}
match_matrix <- address %>% 
  str_match("(.*) <(.*)@(.*)>") 
match_matrix

users <- as_tibble(match_matrix[, 2:4])
names(users) <- c("name", "user", "domain")
users
```

## 次回 {#next}

次回は文字列操作の実践編です。Web ページからデータを取得する方法を学びます。

