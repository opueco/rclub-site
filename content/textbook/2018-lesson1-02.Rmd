---
title: "Lesson 1-2: はじめてのRスクリプト"
date: "2018-10-03"
categories:
  - textbook
tag:
  - R
slug: 2018-1-2
output: 
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(showDetails = function(before, options, envir) {
  if (before) {
    return("<details><summary>答</summary>")
  } else {
    if (!options$doNotClose) return("</details>")
  }
})

knitr::opts_hooks$set(showDetails = function(options) {
  if(options$showDetails) {
    options$echo = FALSE
  }
  return(options)
})

counter <- function(start = 0) {
  count <- start
  .counter <- function() {
    count <<- count + 1
    return(count)
  }
  return(.counter)
}

cnt_exe <- counter()
cnt_prb <- counter()
```

# 前のステップ {#pre}

[Lesson 1-1: R を使ってみよう！](`r blogdown::shortcode("ref", "2018-lesson1-01.html")`) では次のことを勉強しました。

* R を取り巻く環境
* コンソールでコマンド（四則演算と関数）を実行する方法
    * R を電卓として使う
    * R で対数関数・指数関数のグラフを描画する
* 「関数」という言葉の範囲について

# このセッションの目標 {#goal}

[前回]((`r blogdown::shortcode("ref", "2018-lesson1-01.html")`))実行したような簡単な計算を1回だけ行うのにパソコンを立ち上げるは必要ないかもしれません。しかし，ほとんどの仕事はもっと複雑なもので，

* 繰り返し処理
* 条件分岐を含む計算
* あるいはそれらを組み合わせた複雑な処理

をしなければならない場面が現れます。このようなケースにはプログラミングが本領を発揮してくれます。

当然のことながら，やらなければならない処理が複雑になってくると

**コマンドが長くてコンソールでは手狭になる**

という問題が発生します。コマンドをファイルに記録する訳ですが，そうすると

**ファイルが増えて管理が大変になる**

という状態が到来するのは目前です。重要なファイルとそうでないファイルがごちゃ混ぜになって散らかってしまう前に，系統だった管理の方法を確認しておきましょう。その後，ファイルにコマンドを書いて実行する方法を説明します。


# RStudio プロジェクト {#project}

RStudio にはプロジェクトを管理する機能があります。何か新しいことを始めようと思ったときには，まずプロジェクトを作成することをおすすめします。

## Rプロジェクトを作る手順 {#create-project}

RStudio のウインドウの右上角を見てください。下図のように "Project: (None)" となっているときは，どのプロジェクトも開いていない状態です。

![Fig: プロジェクトを開いていない状態](/images/2018-1-2-1-noproject.png)

"New Project..." をクリックして，プロジェクトを作りましょう。新しいプロジェクトをセットアップするためのウィザードが開始されます。


![Fig: 新しいプロジェクト](/images/2018-1-2-2-newproject.png)

"New Directory" か "Existing Directory" のどちらかを選びます：

* New Directory - プロジェクトのフォルダがまだない場合
* Existing Directory - プロジェクトのフォルダをすでに作っている場合

ここでは "New Directory" を選びます。

![Fig: プロジェクトタイプ](/images/2018-1-2-3-projecttype.png)

次に "Project Type" を選ぶように促されますので，これは "New Project" を選んでください。

使用環境に応じて異なる表示をするかもしれませんが，おおよそ次のように表示されます。プロジェクトに相応しい英語の名前をつけましょう。ここでは "RClub" とします。

![Fig: プロジェクト名](/images/2018-1-2-4-projname.png)

RStudio が新しく開くと，右上に "RClub" と表示されます。これでプロジェクトの作成は完了です。

![Fig: プロジェクトに入っている状態](/images/2018-1-2-5-inproject.png)


**練習 `r cnt_exe()`**  
RStudio をすべて閉じてください。エクスプローラーで "RClub.Rproj" ファイルを探してダブルクリックします。RStudio が開いて，プロジェクトが開かれていることを確認してください。

## プロジェクトの設定 {#project-config}

プロジェクトに対する設定を確認しておきましょう。Files の書かれた枠に "RClub.Rproj" というファイルが見えているはずです。これをクリックしてください。

![Fig: Files ペインの "RClub.Rproj"](/images/2018-1-2-6-files.png)

すると，次のような設定画面が表示されます。プロジェクトごとに設定を変えることができますが，基本的には以下の通りに設定することをおすすめします。

**General タブ**

* Restore .RData into workspace at startup: No
* Save workspace to .RData on exit: No
* Always save history (even if not saving .RData): Yes

![Fig: データはコマンド履歴のみ保存する](/images/2018-1-2-7-general.png)

**Code Editing タブ**

Text encoding が UTF-8 になっていることを確認してください。

![Fig: Text encoding は UTF-8](/images/2018-1-2-8-utf.png)

## 最初のRスクリプト  .Rprofile

後ほど詳しく説明しますが，「スクリプト」というのはコマンドを書いたテキストファイルのことです。

`.Rprofile` というファイル（ファイル名の最初がドット，R だけ大文字）は特別なスクリプトで，プロジェクト・フォルダの直下に置いておくと，プロジェクトを開くたびに最初に実行されます。


**練習 `r cnt_exe()`**  
コンソールで次のコマンドを実行して，`.Rprofile` を作成してください。

```{r, file-edit, prompt=TRUE, eval=FALSE}
file.edit(".Rprofile")
```

内容は次のようにして保存します。ただし，"Kenji" のところはあなたの名前に変えてください。

```{r, rprofile, eval=FALSE}
# .Rprofile
message("Hello, Kenji! Today's ", Sys.Date(), ".")
```


**問題 `r cnt_prb()`**  
プロジェクトを再読み込みしてください。起動直後に `.Rprofile` が何をしたか説明してください。

<details>
  <summary>答</summary>
```
R version 3.5.1 (2018-07-02) -- "Feather Spray"
Copyright (C) 2018 The R Foundation for Statistical Computing

.....（中略） .....

Type 'q()' to quit R.

Hello, Kenji! Today's 2018-09-16.    ← ココが増えた！
```
</details>





<div class = "hint">

## .Rprofile の置き場所

ホームディレクトリ（`~`, [コラム参照](`r blogdown::shortcode("ref", "/post/2018-10-03-about-paths.html")`)）に 
`.Rprofile` （以下，`~/.Rprofile`）を置くように推奨している教科書もたくさんありますが，初心者のうちはプロジェクトフォルダだけに `.Rprofile` を書くようにしましょう。ホームディレクトリの `~/.Rprofile` ファイルは遠くにある目に見えないファイルで「自分でさえ書いたことを忘れる」ことがよくあるからです。そんな，忘れがちなファイルであるにも関わらず，R はこれを毎回律儀に実行してしまうので，思いもよらぬ結果をもたらすことがあるのです。授業のレポートに R を使ってもらっていて，学生さんに「よく分からないエラーが出て困っている」と聞かれて調べてみると `~/.Rprofile` が悪さをしていた，ということもありました。

このセクションで無害な `.Rprofile` を書いてもらったのには1つ重要な理由があります。これがあると，`~/.Rprofile` を無視するからです。別の講座や自習のために `~/.Rprofile` を作った人がいても，そちらは読み込まれないようになっています。

もちろん，1つ1つのコードが何をやっているのかが分かるようになってきたら，害のない範囲で `~/.Rprofile` を育てていくのはよい心がけでしょう。その場合でも，プロジェクトフォルダにも `.Rprofile` を作って，プロジェクトだけで必要なコードはプロジェクトの `.Rprofile` だけに書くようにします。最初の行を次のように書いておけば `~/.Rprofile` も読み込んでくれます。

```
if (file.exists('~/.Rprofile')) sys.source('~/.Rprofile', envir = environment())
```


</div>


## プロジェクト・フォルダの構成 {#project-structure}

標準的なデータ分析プロジェクトには，

- コマンドを記録したファイル（ソースコード）
- 生データ
- 生データを処理して出来上がった2次データ
- 分析結果を保存したテキストファイル
- 分析結果のグラフ
- ソースコードの使い方
- 分析結果の解釈などを含めたレポート

などなどが必要になります。以下のように，ファイルの種類に応じたフォルダを作って整理しましょう。もちろん，必要に応じて増やしたり減らしたりしても構いません。

```
RClub/           (プロジェクト・フォルダ)
├── .Rprofile
├── README.Rmd   (後述)
├── Data/
├── Graphics/
├── R/
├── RClub.Rproj
├── Reports/
└── Results/
```

R上でフォルダを作るにはコンソールで次のコマンドを実行します。5つの空のフォルダができあがります。

```
> dir.create("R")
> dir.create("Data")
> dir.create("Results")
> dir.create("Graphics")
> dir.create("Reports")
```

そして，フォルダの内容物に関する規則を決めてしまいましょう。例えば次のように決めます。

------------------------------------------------------------
  フォルダ名    コンテンツ
--------------- --------------------------------------------
R               スクリプト（コマンドを書いたファイル）

Data            データ（生データと前処理済の2次データ）

Results         プロジェクトの出力（主にテキスト形式のもの）

Graphics        プロジェクトで作成したグラフなど

Reports         分析の詳細と解釈などを記載したレポート
-------------------------------------------------------------


# スクリプト {#scripts}

## スクリプトを書く {#write-script}


## スクリプトを実行する {#exec-script}



# コメント {#comments}

## なぜコメントを書くのか？ {#why-write-comments}

次の2コマ漫画は ボズウェル・フォシェ・角征典訳（2012）『リーダブルコード』（_The Art of Readable Code_）オライリーからの引用です（訳書 p. ix）。

![Fig: Readable Code](/images/2018-1-2-9-readable-code.png)

「こんなことがあるはずない」と思うかもしれませんが，実際によくあることです。昔々の経験を思い出すとくすっと笑えるのですが，「2週間後の私」には面白くない冗談かもしれませんね。結局イチから書き直したり・・・・・

要するにそういうことが起こらないように

* コメントをしっかり書きましょう
* 名前は適切に付けましょう（後述）

ということです。



## RStudio のセクショニング機能 {#rstudio-sectioning}




